name: tc04-smoke

on:
  pull_request:
    paths:
      - 'godot/**'
      - 'tools/qa/**'
      - '.github/workflows/tc04-smoke.yml'

jobs:
  tc04:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Use a prebuilt Godot CI image to avoid flaky large downloads/timeouts.
    container:
      image: barichello/godot-ci:4.3

    steps:
      - uses: actions/checkout@v4

      - name: Run TC04 autorun (headless)
        run: |
          set -euo pipefail
          mkdir -p _ci_user

          # godot-ci images sometimes expose the binary under different names/paths.
          GODOT_BIN=""
          if command -v godot >/dev/null 2>&1; then GODOT_BIN="$(command -v godot)"; fi
          if [ -z "$GODOT_BIN" ] && command -v godot4 >/dev/null 2>&1; then GODOT_BIN="$(command -v godot4)"; fi
          if [ -z "$GODOT_BIN" ] && [ -x "/usr/local/bin/godot" ]; then GODOT_BIN="/usr/local/bin/godot"; fi
          if [ -z "$GODOT_BIN" ] && [ -x "/usr/bin/godot" ]; then GODOT_BIN="/usr/bin/godot"; fi
          echo "Using GODOT_BIN=$GODOT_BIN"
          "$GODOT_BIN" --version

          "$GODOT_BIN" --headless --path godot --user-data-dir "$(pwd)/_ci_user" -- --tc04-auto=10 --tc04-timeout=6.0

      - name: Parse latest log
        run: |
          set -euo pipefail
          LOG=$(ls -1t _ci_user/logs/run_*.jsonl | head -n 1)
          echo "Using log: $LOG"
          python3 tools/qa/parse_tc04_log.py "$LOG" --min-attempts 10 --min-success 1
